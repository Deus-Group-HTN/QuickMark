<!DOCTYPE html>
<html lang="en">
   <head>
      <title>QuickMark</title>
	  <meta charset="utf-8">
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
      <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
      <meta property="og:title" content="QuickMark" />
      <meta property="og:type" content="website" />
      <meta property="og:url" content="https://quickmark.victorwei.com" />
      <meta property="og:image" content="https://quickmark.victorwei.com/content.png" />
      <meta property="og:description" content="MARK EASY" />
      <meta name="keywords" content="HTML, CSS, JavaScript, Three.js">
      <meta name="author" content="Deus Group">

      <link rel="shortcut icon" type="image/png" href="favicon.png"/>

      <style>
         body {
         	font-family: sans-serif, "Times New Roman", Georgia, Serif;
  			
         }
         h1, h2, h3, h4, h5, h6 {
         font-family: sans-serif;
         }
         body {
         background-color: #ffffff;
         font-family: sans-serif;
         }
         .item {
         display: inline-block;
         }
         .individual-question {
         display: block;
         }
         #bodysection {
		 }
		 #navbarbrand {
			 color: rgb(255, 69, 0);
			 font-weight:bold;
		 }
		 #titlemark {
			 color: rgb(255, 69, 0);
			 font-weight: bold;
		 }
		 a.button4{
			display:inline-block;
			padding:1em 2em;
			margin:0 0.1em 0.1em 0;
			border:0.16em solid rgba(255,255,255,0);
			border-radius:2em;
			box-sizing: border-box;
			text-decoration:none;
			font-family:'Roboto',sans-serif;
			font-weight:300;
			color:#FFFFFF;
			text-shadow: 0 0.04em 0.04em rgba(0,0,0,0.35);
			text-align:center;
			transition: all 0.2s;
		 }
		 a.button4:hover{
			border-color: rgba(255,255,255,1);
		 }

		.form__group {
			width: 20%;
		}

		.form__field {
			font-family: inherit;
  			border: 0;
  			border-bottom: 2px solid grey;
  			outline: 0;
			
  			color: black;
	  		padding: 7px 0;
  			background: transparent;
			transition: border-color 0.2s;
		}

		#commentsunderscore {
			width: 50%;
		}

		.form__label {
			position: absolute;
			top: 0;
			display: block;
			transition: 0.2s;
			color: gray;
		}

		.section {
			position: relative;
			display: table-cell;
			width: 100vw;
			height: 100vh;
			vertical-align: middle;
			text-align: center;
		}

		.inner-section {
			display: inline-block;
  			text-align: center;
		}

		.intro-subtitle{
			font-family: sans-serif;
			font-size: 40px;
		}

		#home_section {
			
		}

		#upload_section {
			background-color: lightblue;
		}

		#marking_section {
			background-color: white;
		}

		#score_section {
			background-color: lightblue;
		}

		.student-answer {
			max-height: 60vh;
			overflow: auto;
		}

		table, th, td {
		  border: 1px solid black;
		}

      </style>
      <link rel="stylesheet" href="./css/owl.carousel.css">
      <link rel="stylesheet" href="./css/owl.theme.default.css">
   	</head>
   	<body>
      <!-- Navbar (sit on top) -->
      <div class="w3-top">

         <div class="w3-bar w3-white w3-padding w3-card" style="letter-spacing:3px;">

         	<img src="favicon.png" style="height: 38px; ">
            <a id="home-nav" class="w3-bar-item w3-button"><span id="navbarbrand">quickmark</span>.online</a>
            <!-- Right-sided navbar links. Hide them on small screens -->
            <div class="w3-right w3-hide-small">
               <a id="upload-nav" class="w3-bar-item w3-button">Upload</a>
               <a id="mark-nav" class="w3-bar-item w3-button">Mark</a>
               <a id="score-nav" class="w3-bar-item w3-button">Student Scores</a>
            </div>
         </div>
      </div>
      

      <!-- Big Boy Body -->
      <div id="bodysection">

      	<!-- HOME -->

      	<div id="home_section" class="section" >
      		<div class="inner-section">

		        <h1 style="font-family: sans-serif; font-size: 10vh;" class="animate__animated animate__bounce">Quick<span id="titlemark">Mark.</span></h1>
		        <p class="intro-subtitle"><span class="text-slider-items" style="display: none">Fast., Easy., Reliable.</span><strong class="text-slider"></strong><span class="typed-cursor"></span></p>

		        <br>
		        <br>
		        <br>
		        <br>
		        <br>
		        <a href="#" class="button4" id="getStarted" style="background-color:rgb(255, 69, 0)">Get Started</a>
	    	</div>
      	</div>
		<div id="jumptouploads"></div>


		<!-- UPLOAD -->

        <div id="upload_section" style="height: 100vh; vertical-align: middle; display: table-cell;width: 100vw;">

         	<center class="vertical">
	            <h1>Upload Tests</h1>
				<br>
		        <br>
		        <br>
		        <br>
		        <br>
				<input type="file" id="siofu_input" style="display:none" multiple/>
				<a class="button4 addfiles" style="background-color:rgb(255, 69, 0); cursor: pointer">Upload Student Tests</a>
				<a id="try_sample" class="button4" style="background-color:rgb(255, 69, 0); cursor: pointer">Try Sample Tests</a>
				<br>
	            <br><progress id="upload_progress" value="0" max="100"> 0% </progress>
	        </center>
         </div>
		 <div id="jumptomarkings"></div>

         <!-- MARK -->

         <div id="marking_section" style="height: 100vh; display: table-cell;width: 100vw; text-align: center; position: relative; padding-top: 10vh">
            <h1>Marking Section</h1>
            <h3 id="currentStudent"></h3>
            <h3 id="currentQuestion"></h3>
            <div id="owl-demo" class="owl-carousel owl-theme" style="width: 100vw; min-height: 30vh">
            	<h1 style="color: red">Please Upload Tests First</h1>
            </div>

            <div id="marking_controls" style="position: absolute; bottom: 0; left: 50%; transform: translate(-50%, -20%);"> 
				<div class="form_group field">
					<input type="input" class="form__field" id="score" placeholder="Score">	
					<label class="form__label"></label>
				</div>
			
				<br>

				<div class="form_group field">
					<label class="form__label"></label>
					<input id="comment" type="text" class="form__field" style="width: 30vw;" id="commentsunderscore" placeholder="Comments">
				</div>
				<br>
			<!--
			<p class="button4" id="submit_score" style="background-color:rgb(255, 69, 0)"> Submit</p>
			<p class="button4" id="prev_question" style="background-color:rgb(255, 69, 0)"> Previous Question</p>
			<p class="button4" id="next_question" style="background-color:rgb(255, 69, 0)"> Next Question</p>
			-->
			<a class="button4" id="submit_score" style="background-color:rgb(255, 69, 0)"> Submit</a>
			<a class="button4" id="prev_question" style="background-color:rgb(255, 69, 0)"> Previous Question</a>
			<a class="button4" id="next_question" style="background-color:rgb(255, 69, 0)"> Next Question</a>	

			</div>

		 </div>
		 <div id="jumptoss"></div>
        

         <!-- SCORE -->

         <div id="score_section" style="height: 100vh; display: table-cell;width: 100vw;padding-top: 10vh">
            <center>
            	<h1>View Student Scores</h1>
            	<table id="entire_table">
            		<tbody id="scores_table"></tbody>
            	</table>
            	<a class="button4" id="download_csv" style="background-color:rgb(255, 69, 0)"> Download CSV</a>
            </center>

         </div>
	  </div>
	  
      <!-- Load Resources -->
      <script src="javascripts/socket.io.js"></script>
      <script src="javascripts/jquery.js"></script>
      <script src="javascripts/owl.carousel.js"></script>
      <script src="javascripts/client.js"></script>
      <script src="javascripts/typed.js"></script>
      <script>

      	/*

      		NAV SECTION

      	*/

      	$("#home-nav").click(function () {
      		$('html,body').animate({
	        scrollTop: $("#home_section").offset().top},
	        'slow');
      	})

      	$("#upload-nav").click(function () {
      		$('html,body').animate({
	        scrollTop: $("#upload_section").offset().top},
	        'slow');
      	})

      	$("#mark-nav").click(function () {
      		$('html,body').animate({
	        scrollTop: $("#marking_section").offset().top},
	        'slow');
      	})

      	$("#score-nav").click(function () {
      		$('html,body').animate({
	        scrollTop: $("#score_section").offset().top},
	        'slow');
      	})

      	/*

      		HOME SECTION

      	*/
      	 if ($('.text-slider').length == 1) {
		    var typed_strings = $('.text-slider-items').text();
		    var typed = new Typed('.text-slider', {
		      strings: typed_strings.split(','),
		      typeSpeed: 80,
		      loop: true,
		      backDelay: 1100,
		      backSpeed: 30
		    });
		}

		$("#getStarted").click(function () {
			$('html,body').animate({
	        scrollTop: $("#upload_section").offset().top},
	        'slow');
		})

        /*
        
         	UPLOAD TESTS SECTION
        
        */

        $("#try_sample").click(function () {
        	socket.emit('sampleTests');
        	numberOfQuestions = 8;
        	numberOfFiles = 3;
        })

        $('.addfiles').on('click', function() { $('#siofu_input').click();return false;});

        var socket = io.connect();
        var uploader = new SocketIOFileUpload(socket);
        uploader.listenOnInput(document.getElementById("siofu_input"));
        var numberOfFiles = 0;

        // Choose event

        uploader.addEventListener("choose", function (event) {
        	numberOfFiles = event.files.length;
        })
         
        // Start event
         
        uploader.addEventListener("start", function (event) {
        	console.log(event)
        	console.log("Starting upload", event.file.name)
        })
         
        // Progress event
         
        uploader.addEventListener("progress", function (event) {
         	var percentage = event.bytesLoaded / event.file.size * 100;
         	$("#upload_progress").val(percentage)
        })
        
        // Complete Event
        
        var updateId;
         
        uploader.addEventListener('complete', function (event) {
        	console.log("Completed upload", event.file.name)

        })
         
        uploader.addEventListener('error', function (event) {
        	console.log("Error upload", event.file.name)
        })
        
        
        /*
         
         	MARKING SECTION
         
        */
        
        let students = [];
        let numberOfQuestions = 0;

        let owl = $(".owl-carousel");

        owl.owlCarousel({
           	center: true,
     	    loop:false,
     	    nav:true,
     	    items: 2,
     	    margin: 50
       	});
         
        socket.on('files', function (data) {
        	console.log("Received", data.name, "files")

        	students.push({
        		name: data.name,
        		files: data.files,
        		score: [],
        		comments: []
        	})
        	console.log(students.length)
        	if (students.length == numberOfFiles) {
        		// FINISHED UPLOADING

        		$("#marking_section").show();
        		numberOfQuestions = data.files.length;
        		displayQuestion(1);
        		$("#upload_section").css("background-color", "lightgreen");

        		$('html,body').animate({
		        scrollTop: $("#marking_section").offset().top},
		        'slow');
        	}
        })

        function displayQuestion(questionNumber) {
        	$("#currentStudent").text("Student: " + students[currStudent].name)
        	$("#currentQuestion").text("Question: " + currQuestion + "/" + numberOfQuestions)

        	for (var i=0; i<100; i++) {
			   $(".owl-carousel").trigger('remove.owl.carousel', [i]).trigger('refresh.owl.carousel');
			}

        	for (let student of students) {
        		let studentAnswers = student.files;

        		let path = "./questions/" + student.name + "/" + studentAnswers[questionNumber-1];
         		let content = "<div class='student-answer'><img class='answer-image' src='" + path + "''></div>"
        		$('.owl-carousel').trigger('add.owl.carousel', [content]).trigger('update.owl.carousel').trigger('refresh.owl.carousel');
        	}
        }
        
        $(window).keyup(function (event) {    
         
            // handle cursor keys
            if (event.keyCode == 37) {
                owl.trigger('prev.owl.carousel');
            } else if (event.keyCode == 39) {
                owl.trigger('next.owl.carousel');
            }
        
        });
         
        let currQuestion = 1;
        let currStudent = 0;
         
        $("#score").keydown(function (event) {
         	if (event.keyCode == 13) {

         		students[currStudent].score[currQuestion-1] = parseInt($("#score").val())

         		console.log("Gave a score of",$("#score").val(),"to",students[currStudent].name)
         		owl.trigger('next.owl.carousel');
         		$("#score").val("")

         		var first_row = ["Name"];
				for (var i = 1; i <= numberOfQuestions; i++) {
				  first_row.push("Question " + i);
				}
				first_row.push("Total Score")

				// UPDATE TABLE
				$("#entire_table").show();
				var rows = [first_row];

				for (student of students) {
				  var row = [student.name];
				  let total_score = 0;
				  for (let i = 0; i < numberOfQuestions; i++) {
				      row.push(student.score[i]);
				    total_score += student.score[i] || 0;
				  }
				  row.push(total_score)

				  rows.push(row);
				}

				const tbody = document.getElementById("scores_table");
				tbody.innerHTML = "";
				for (var i = 0; i < rows.length; i++) {
				  var rowElement = document.createElement("tr");
				  var row = rows[i];
				  for (var j = 0; j < row.length; j++) {
				    var cellElement = document.createElement("td");
				    var cellText = document.createTextNode(row[j] || "");
				    cellElement.appendChild(cellText);
				    rowElement.appendChild(cellElement);
				  }
				  tbody.appendChild(rowElement);
				}
         	}
        })
         
        owl.on('changed.owl.carousel', function (e) {
 			currStudent = e.item.index;
 			if (currStudent != null && students[currStudent])
        		$("#currentStudent").text("Student: " + students[currStudent].name)
   		});

   		$("#next_question").click(function () {
   			if (currQuestion < numberOfQuestions) {
   				console.log("Moving to question", currQuestion+1)

   				currQuestion += 1;
   				$("#currentQuestion").text("Question: " + currQuestion + "/" + numberOfQuestions)
   				displayQuestion(currQuestion)
   			}
   		})

   		$("#prev_question").click(function () {
   			if (currQuestion > 1) {
   				console.log("Moving to question", currQuestion-1)
   				currQuestion -= 1;
   				$("#currentQuestion").text("Question: " + currQuestion + "/" + numberOfQuestions)
   				displayQuestion(currQuestion)
   			}
   		})
 
         
        /*
         
         	VIEW SCORE SECTION
         
        */


        $("#download_csv").click(function() {

	        var first_row = ["Name"];
			for (var i = 1; i <= numberOfQuestions; i++) {
			  first_row.push("Question " + i);
			}
			first_row.push("Total Score")

			var rows = [first_row];

	        for (student of students) {
	          var row = [student.name];
	          let total_score = 0;
	          for (let i = 0; i < numberOfQuestions; i++) {
	          	row.push(student.score[i]);
	            total_score += student.score[i] || 0;
	          }
	          row.push(total_score)

	          rows.push(row);
	        }

	        let csvContent = "data:text/csv;charset=utf-8,"
	            + rows.map(e => e.join(",")).join("\n");
	            var encodedUri = encodeURI(csvContent);
	        var link = document.createElement("a");
			link.setAttribute("href", encodedUri);
			link.setAttribute("download", "marks.csv");
			document.body.appendChild(link); // Required for FF

			link.click();
	    })
         
      </script>
   </body>
</html>